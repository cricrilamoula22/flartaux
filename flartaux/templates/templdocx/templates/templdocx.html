<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rer le document</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Add French locale for flatpickr -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
</head>
<body>
<a href="/templdocx/download_zip" download class="btn btn-primary">
  üì• T√©l√©charger le fichier ZIP
</a>
<div id="auto-delete-msg" style="display: none; margin-top: 10px;"></div>

<script>
  document.querySelector('a[href="/templdocx/download_zip"]').addEventListener('click', function () {
    const msgBox = document.getElementById('auto-delete-msg');
    msgBox.style.display = 'block';
    msgBox.textContent = "‚è≥ Attention : les fichiers seront supprim√©s dans 30 secondes...";
    setTimeout(() => {
      msgBox.textContent = "‚úÖ Fichiers supprim√©s du serveur.";
    }, 30000);
  });
</script>
<div class="container mt-5">
    <h1>G√©n√©rer le document</h1>

    <!-- Form for selecting dates -->
    <form id="date-form" method="POST" action="{{ url_for('templdocx.generate') }}">
        <div class="mb-3">
            <label for="start_date" class="form-label">Date de d√©but</label>
            <input type="text" class="form-control" id="start_date" name="start_date" placeholder="S√©lectionner la date de d√©but" required>
        </div>
        <div class="mb-3">
            <label for="end_date" class="form-label">Date de fin</label>
            <input type="text" class="form-control" id="end_date" name="end_date" placeholder="S√©lectionner la date de fin" required>
        </div>
        <button type="submit" class="btn btn-primary" id="generate-btn">G√©n√©rer</button>
    </form>

    <!-- Status message for the document generation process -->
    <div id="status-message" class="mt-3"></div>
</div>

<script>
// Initialize flatpickr with French locale for the datepickers
flatpickr("#start_date", {
    locale: "fr",  // Set French locale
    dateFormat: "Y-m-d",  // Set the date format to YYYY-MM-DD
    maxDate: "today",  // Optional: Set max date to today
});

flatpickr("#end_date", {
    locale: "fr",  // Set French locale
    dateFormat: "Y-m-d",  // Set the date format to YYYY-MM-DD
    maxDate: "today",  // Optional: Set max date to today
});

// Handle form submission with AJAX
document.getElementById("date-form").addEventListener("submit", function(event) {
    event.preventDefault();
    const startDate = document.getElementById("start_date").value;
    const endDate = document.getElementById("end_date").value;

    // Show status message while generating the document
    const statusMessage = document.getElementById("status-message");
    statusMessage.innerHTML = "G√©n√©ration du document... Veuillez patienter.";

    // Send AJAX request to generate the document
    fetch("{{ url_for('templdocx.generate') }}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ start_date: startDate, end_date: endDate }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'in_progress') {
            statusMessage.innerHTML = "La g√©n√©ration du document est en cours. Veuillez patienter...";
            checkStatus();  // Check status periodically
        } else {
            statusMessage.innerHTML = "La g√©n√©ration du document est termin√©e. <a href='" + data.download_link + "'>T√©l√©chargez votre document ici.</a>";
        }
    })
    .catch(error => {
        statusMessage.innerHTML = "Une erreur est survenue lors de la g√©n√©ration du document.";
    });
});

// Function to check document generation status
let statusCheckInterval;

function checkStatus() {
    statusCheckInterval = setInterval(() => {
        fetch("{{ url_for('templdocx.check_status') }}")
        .then(response => response.json())
        .then(data => {
            if (data.status === 'complete') {
                // Stop the periodic check once the document is ready
                clearInterval(statusCheckInterval);
                document.getElementById("status-message").innerHTML = "La g√©n√©ration du document est termin√©e. <a href='" + data.download_link + "'>T√©l√©chargez votre document ici.</a>";
            } else {
                document.getElementById("status-message").innerHTML = `La g√©n√©ration du document est en cours. Temps √©coul√© : ${Math.round(data.elapsed_time)} secondes.`;
            }
        })
        .catch(error => {
            document.getElementById("status-message").innerHTML = "Une erreur est survenue lors de la g√©n√©ration du document.";
        });
    }, 5000);  // Check every 5 seconds
}

// Stop checking if the document is ready when the page reloads
function stopCheckingStatus() {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
    }
}

</script>
<div id="message-info" style="display: none;">
  ‚ö†Ô∏è Les fichiers seront supprim√©s automatiquement dans 30 secondes.
</div>

<script>
  // Affiche le message apr√®s clic sur le lien
  document.querySelector('a[href="/templdocx/download_zip"]').addEventListener('click', function () {
    document.getElementById('message-info').style.display = 'block';
    setTimeout(() => {
      document.getElementById('message-info').textContent = "‚è≥ Les fichiers ont √©t√© supprim√©s.";
    }, 30000);
  });
</script>


</body>
</html>
